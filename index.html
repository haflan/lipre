<html>
<head>
    <title>lipre</title>
</head>
<body>
    <div id="roomEntry">
        <input id="roomCode"/>
        <button onclick="present(getRoomCode())">Present</button>
        <button onclick="view(getRoomCode())">View</button>
        <div id="statusMessage"></div>
    </div>
    <textarea id="editor" style="display:none;height:100%; width:100%"></textarea>
    <pre><code id="viewer" style="display:none;height:100%; width:100%; white-space: pre"></code></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
    <script>
        let getRoomCode = element => document.getElementById("roomCode").value
        let setStatus = (message) => document.getElementById("statusMessage").innerText = message
        let setCode = (message) => document.getElementById("viewer").innerText = message
        let getCode = (message) => document.getElementById("editor").value
        let hide = element => document.getElementById(element).style.display = "none"
        let show = element => document.getElementById(element).style.display = "inline"
        function connect(roomCode, present, openCallback) {
            let url = "ws://" + document.location.host + (present ? "/pres/" : "/view/") + roomCode
            window.ws = new WebSocket(url)
            window.files = {}
            ws.onclose = () => {
                setStatus("No connection to the given room")
            }
            ws.onopen = () => {
                setStatus("Connected")
                openCallback()
            }
            ws.onmessage = (msg) => {
                let fileReceived = JSON.parse(msg.data)
                window.files[fileReceived.name] = fileReceived.contents
                setCode(fileReceived.contents)
                hljs.highlightBlock(document.getElementById("viewer"))
            }
        }
        function present(roomCode) {
            connect(roomCode, true, () => {
                hide("roomEntry")
                hide("viewer")
                show("editor")
            })
        }
        function view(roomCode) {
            connect(roomCode, false, () => {
                hide("roomEntry")
                hide("editor")
                show("viewer")
            })
        }
        // Allow direct connection with room code
        let qParams = new URLSearchParams(window.location.search)
        let roomCode = qParams.get("room")
        let presentFlag = qParams.get("present")
        if (roomCode) {
            if (presentFlag) {
                present(roomCode)
            } else {
                view(roomCode)
            }
        }
        let editor = document.getElementById("editor")
        editor.addEventListener("keyup", function(e) {
            if (e.keyCode === 13) {
                window.ws.send(getCode())
            }
        })
        editor.addEventListener("keydown", function(e) {
            if (e.keyCode === 9 || e.which === 9) {
                console.log("arsiontarst")
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;

                // set textarea value to: text before caret + tab + text after caret
                this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);

                // put caret at right position again
                this.selectionStart = this.selectionEnd = start + 1;
            }
        })

    </script>
</body>
</html>
